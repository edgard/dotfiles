#!/usr/bin/env bash
# Fetch secrets from Bitwarden and write attachments to ~/.config/local
set -euo pipefail

# Skip if bw not installed
command -v bw &>/dev/null || { echo "==> Skipping secrets (bw not installed)"; exit 0; }
command -v jq &>/dev/null || { echo "Error: jq not installed" >&2; exit 1; }

bw_item="_chezmoi_{{ .profile }}"
secrets_dir="$HOME/.config/local"

echo "==> Fetching secrets from Bitwarden..."

# Login/unlock Bitwarden (interactive)
if ! bw login --check &>/dev/null; then
    echo "==> Logging in to Bitwarden..."
    if ! BW_SESSION=$(bw login --raw </dev/tty); then
        echo "==> Bitwarden login failed. Run 'update secrets' after logging in with 'bw login'"
        exit 0
    fi
    export BW_SESSION
else
    if ! BW_SESSION=$(bw unlock --raw </dev/tty); then
        echo "==> Failed to unlock Bitwarden. Run 'update secrets' manually."
        exit 0
    fi
    export BW_SESSION
fi

# Sync vault
bw sync || { echo "Error: Bitwarden sync failed" >&2; exit 1; }

# Get item and extract attachments
item_json=$(bw get item "$bw_item") || { echo "Error: Failed to get Bitwarden item: $bw_item" >&2; exit 1; }
item_id=$(echo "$item_json" | jq -r '.id')
attachments=$(echo "$item_json" | jq -r '.attachments // []')

if [[ $(echo "$attachments" | jq 'length') -gt 0 ]]; then
    mkdir -p "$secrets_dir"
    while read -r attachment; do
        att_id=$(echo "$attachment" | jq -r '.id')
        att_name=$(echo "$attachment" | jq -r '.fileName')
        echo "  Writing $att_name..."
        bw get attachment "$att_id" --itemid "$item_id" --output "$secrets_dir/$att_name"
    done < <(echo "$attachments" | jq -c '.[]')
else
    echo "  No attachments found on $bw_item"
fi

# Lock vault
bw lock
