#!/usr/bin/env bash
# Install Xcode CLI, Homebrew, and packages (macOS only)
set -euo pipefail

# Skip if not macOS
[[ "$(uname)" == "Darwin" ]] || { echo "==> Skipping macOS dependencies (not macOS)"; exit 0; }

echo "==> Installing dependencies..."

# --- Xcode CLI Tools ---
if ! xcode-select -p &>/dev/null; then
    echo "==> Installing Xcode Command Line Tools..."
    xcode-select --install
    echo "Complete the installation prompt, then press Enter..."
    read -r
    if ! xcode-select -p &>/dev/null || ! command -v git &>/dev/null; then
        echo "Error: Xcode CLI tools installation failed" >&2
        exit 1
    fi
fi

# --- Homebrew ---
if ! command -v brew &>/dev/null; then
    echo "==> Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi
for prefix in /opt/homebrew /usr/local; do
    [[ -x "$prefix/bin/brew" ]] && { eval "$("$prefix/bin/brew" shellenv)"; break; }
done
if ! command -v brew &>/dev/null; then
    echo "Error: Homebrew installation failed" >&2
    exit 1
fi

# --- Homebrew packages ---
echo "==> Installing Homebrew packages..."
brewfile_common="{{ .chezmoi.sourceDir }}/extras/Brewfile.common"
brewfile_profile="{{ .chezmoi.sourceDir }}/extras/Brewfile.{{ .profile }}"

if [[ ! -f "$brewfile_common" ]]; then
    echo "Error: Brewfile.common not found" >&2
    exit 1
fi
if [[ ! -f "$brewfile_profile" ]]; then
    echo "Error: Brewfile.{{ .profile }} not found" >&2
    exit 1
fi

brew bundle --file="$brewfile_common"
brew bundle --file="$brewfile_profile"
