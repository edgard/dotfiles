#!/usr/bin/env bash
# Install Xcode CLI and Homebrew (macOS only)
set -euo pipefail

# Skip if not macOS
[[ "$(uname)" == "Darwin" ]] || { echo "==> Skipping macOS dependencies (not macOS)"; exit 0; }

echo "==> Installing dependencies..."

# --- Xcode CLI Tools ---
if ! xcode-select -p &>/dev/null; then
    if [[ ! -t 0 ]]; then
        echo "Error: Xcode Command Line Tools are required and bootstrap must run in an interactive terminal." >&2
        exit 1
    fi
    echo "==> Installing Xcode Command Line Tools..."
    xcode-select --install
    echo "Complete the installation prompt, then press Enter..."
    read -r
    if ! xcode-select -p &>/dev/null || ! command -v git &>/dev/null; then
        echo "Error: Xcode CLI tools installation failed" >&2
        exit 1
    fi
fi

# --- Homebrew ---
if ! command -v brew &>/dev/null; then
    echo "==> Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi
for prefix in /opt/homebrew /usr/local; do
    [[ -x "$prefix/bin/brew" ]] && { eval "$("$prefix/bin/brew" shellenv)"; break; }
done
if ! command -v brew &>/dev/null; then
    echo "Error: Homebrew installation failed" >&2
    exit 1
fi
