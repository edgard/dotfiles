#!/usr/bin/env bash
set -euo pipefail

# Re-run when either Brewfile changes.
# Brewfile.common hash: {{ include "extras/Brewfile.common" | sha256sum }}
# Brewfile.{{ .profile }} hash: {{ include (printf "extras/Brewfile.%s" .profile) | sha256sum }}

[[ "$(uname)" == "Darwin" ]] || { echo "==> Skipping Homebrew packages (not macOS)"; exit 0; }
for prefix in /opt/homebrew /usr/local; do
    [[ -x "$prefix/bin/brew" ]] && { eval "$("$prefix/bin/brew" shellenv)"; break; }
done
if ! command -v brew &>/dev/null; then
    echo "Error: Homebrew is required but not installed. Run bootstrap install-deps first." >&2
    exit 1
fi

update_script="{{ .chezmoi.sourceDir }}/dot_local/bin/executable_update"
if [[ ! -f "$update_script" ]]; then
    echo "Error: update script not found: $update_script" >&2
    exit 1
fi
if ! command -v python3 &>/dev/null; then
    echo "Error: python3 is required to run $update_script" >&2
    exit 1
fi

echo "==> Syncing Homebrew packages from Brewfiles..."
python3 "$update_script" --profile "{{ .profile }}" install
