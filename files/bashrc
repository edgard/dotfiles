#!/usr/bin/env bash

# -----------------------------------------------------------------------------
# basic setup
# -----------------------------------------------------------------------------
# if not running interactively, don't do anything
[[ $- != *i* ]] && return

# set locale
export LC_ALL="en_US.UTF-8"
export LANG="en_US.UTF-8"
export LANGUAGE="en_US.UTF-8"

# helper funcions
if_os() { [[ $OSTYPE == *$1* ]]; }

#startx
if_os linux && if [[ -z "${DISPLAY}" ]] && [[ "$(tty)" == "/dev/tty1" ]]; then exec startx; fi

# -----------------------------------------------------------------------------
# bash options
# -----------------------------------------------------------------------------
shopt -s checkwinsize
shopt -s cmdhist
shopt -s histappend
shopt -s direxpand
shopt -s dirspell

bind 'set colored-completion-prefix on'
bind 'set colored-stats on'
bind 'set completion-ignore-case on'
bind 'set completion-query-items 200'
bind 'set mark-symlinked-directories on'
bind 'set page-completions off'
bind 'set show-all-if-ambiguous on'
bind 'set skip-completed-text on'
bind 'set visible-stats on'
bind 'set enable-keypad on'
bind '"\e[A": history-search-backward'
bind '"\e[B": history-search-forward'

HISTCONTROL="erasedups:ignoreboth"
HISTIGNORE="&:[ ]*:exit:ls:bg:fg:history:clear:update"
HISTFILESIZE="100000"
HISTSIZE="${HISTFILESIZE}"

# bash prompt
PS1='[\u \W]\$ '

# additional local paths
export PATH="/usr/local/bin:/usr/local/sbin:${PATH}"

# pager
export PAGER="less"
export LESS="FRX"

# ls colors
if_os linux && [[ -f "${HOME}/.dir_colors" ]] && eval "$(dircolors -b "${HOME}/.dir_colors")"
if_os darwin && export LSCOLORS="ExGxFxdaCxDaDahbadacec"

# aliases
alias grep="grep --color --exclude-dir=.hg --exclude-dir=.svn --exclude-dir=.git --exclude-dir=.bzr --exclude-dir=CVS --binary-files=without-match"

if_os linux && {
    alias ls="ls -FGhN --color=auto"
    function update() {
        yay -Syyuu --needed
        yay -Rns "$(yay -Qtdq)"
        (cd ~/.pyenv && git pull)
        (cd ~/.pyenv/plugins/pyenv-virtualenv && git pull)
        (cd ~/.pyenv/plugins/xxenv-latest && git pull)
        (cd ~/.tfenv && git pull)
    }
    function setenv() {
        case $1 in
        proxy)
            local _proxy="http://***REMOVED***:3128"
            export http_proxy="${_proxy}"
            export https_proxy="${_proxy}"
            export HTTP_PROXY="${_proxy}"
            export HTTPS_PROXY="${_proxy}"
            export ALL_PROXY="${_proxy}"
            ;;
        -proxy)
            unset http_proxy https_proxy HTTP_PROXY HTTPS_PROXY ALL_PROXY
            ;;
        creds)
            export GOOGLE_APPLICATION_CREDENTIALS="${HOME}/.creds/gcp/jenkins.json"
            ;;
        -creds)
            unset GOOGLE_APPLICATION_CREDENTIALS
            ;;
        pynossl)
            export PYTHONHTTPSVERIFY="0"
            ;;
        -pynossl)
            unset PYTHONHTTPSVERIFY
            ;;
        *)
            echo "Need to specify which env varibles to set"
            ;;
        esac
    }
}

if_os darwin && {
    alias ls="ls -FGh"
    function update() {
        brew update
        brew upgrade
        brew cask outdated | xargs brew cask reinstall
        mas upgrade
        brew cleanup -s
    }
}

# -----------------------------------------------------------------------------
# tools
# -----------------------------------------------------------------------------
if_os linux && {
    # go
    if command -v go 1>/dev/null 2>&1; then
        export GOPATH="${HOME}/.go"
        export PATH="${GOPATH}/bin:${PATH}"
    fi

    # pyenv
    if [[ -s "${HOME}/.pyenv/bin/pyenv" ]]; then
        export PYENV_VIRTUALENV_DISABLE_PROMPT=1
        export PATH="${HOME}/.pyenv/bin:${PATH}"
        eval "$(pyenv init -)"
    fi

    # tfenv
    [[ -s "${HOME}/.tfenv/bin/tfenv" ]] && export PATH="${HOME}/.tfenv/bin:${PATH}"
}

# -----------------------------------------------------------------------------
# additional path manipulation
# -----------------------------------------------------------------------------
# includes user's private bin if it exists
[[ -d "${HOME}/.local/bin" ]] && export PATH="${HOME}/.local/bin:${PATH}"

# remove duplicate path entries
PATH="$(perl -e 'print join(":", grep { not $seen{$_}++ } split(/:/, $ENV{PATH}))')"
