#!/usr/bin/env bash

##############################################################################
# macOS System Package Installation
##############################################################################

echo "Installing essential macOS system packages..."

# Trigger Command Line Developer Tools installation by attempting to use git
if ! xcode-select -p &>/dev/null; then
    echo "Command Line Developer Tools not found. Triggering installation..."
    git --version

    echo ""
    echo "⚠️  IMPORTANT: Please complete the Command Line Developer Tools installation prompt."
    echo "   When the installation is complete, press Enter to continue..."
    read -r

    # Verify installation completed
    if ! xcode-select -p &>/dev/null; then
        echo "Command Line Developer Tools installation appears to have failed."
        echo "Please install manually with: xcode-select --install"
        echo "Then run this script again."
        exit 1
    else
        echo "Command Line Developer Tools installation completed successfully."
    fi
fi

##############################################################################
# Homebrew Installation
##############################################################################

echo "Checking Homebrew installation..."

if ! command -v brew >/dev/null 2>&1; then
    echo "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

    # Add Homebrew to PATH
    if [[ -f "/opt/homebrew/bin/brew" ]]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
    elif [[ -f "/usr/local/bin/brew" ]]; then
        eval "$(/usr/local/bin/brew shellenv)"
    fi
fi

##############################################################################
# Finalization
##############################################################################

echo "System and user package installation complete."
